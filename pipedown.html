<!DOCTYPE html>
<html lang="pt">
<head>
	<title>lnk2pipe - pipedown</title>
	<meta charset="utf-8">
	<meta name="description" content="Automating Pipedrive data download as CSV file">
	<meta name="keywords" content="pipedrive, automating, download, csv">
	<meta name="author" content="Artaxexes J. Ferreira">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="img/favicon.ico" type="image/x-icon">
	<!-- jquery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- jqueryui -->
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
	<!-- bootstrap -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
        div {
            text-align: center
        }
    </style>
</head>
<body>
	<div class="container">
		<div class="jumbotron">
			<a href="index.html"><h1>lnk2pipe</h1></a>
			<p>Interação (um pouco) automatizada com <a href="http://www.pipedrive.com" target="_blank">Pipedrive</a></p>
		</div>
		<div class="row">
			<div class="col-md-12">
				<p>Download de dados do <a href="http://www.pipedrive.com" target="_blank">Pipedrive</a> em formato de arquivo <a href="https://tools.ietf.org/html/rfc4180" target="_blank">CSV</a></p>
				<div class="form-group">
					<label for="token">Token:</label>
					<input type="text" class="form-control" id="token" size="40" value="" readonly>
					<span class="help-block">Seu token de API pessoal que pode ser encontrado em Ajustes > Pessoal > API no site do Pipedrive</span>
					<button type="submit" class="btn btn-default" id="token">Download</button>
				</div>
				<div class="panel-footer">
					<p>Problemas? <a href="mailto:anddrei.ferreira@biggdata.com.br?Subject=pipedown" target="_top">anddrei.ferreira@biggdata.com.br</a></p>
				</div>
			</div>
		</div>
	</div>
	<script>
        $("button").click(function(event){
			var downNow = false;
			var csv = "data:text/csv;charset=utf-8,";
            csv += "Fechamento,Competidor,Status,Produtos,Empresa,Oportunidade,Tipo,Adicionada,Feito,Em,Evento,Descricao\r\n";
            var token = document.getElementById("token").value;
            var start = 0;
			var limit = 500;
            var url = "https://api.pipedrive.com/v1/deals?api_token=" + token + "&start=" + start + "&limit=" + limit;
			$.ajax({url: url,
					dataType: 'json',
					async: false,
					error: function(err){
						console.log(err.status + ": " + err.statusText);
					},
					success: function(data){
						getIDs(data);
					}
			});
			function getIDs(data){
				var length = data["data"].length;
				var ids = [];
				if(data["additional_data"]["pagination"]["more_items_in_collection"]){
					alert("There is more items in collection");
				}
				if(length > 0){
					var lastActivity = false;
					for(var i = 0; i < length; i += 1){
						if(data["data"][i]["last_activity_id"] !== null){
							lastActivity = true;
							ids.push(data["data"][i]["id"]);
						}
					}
					lastActivity ? getLastActivity(ids) : alert("There is no deal with last activity");
				} else {
					alert("There is no data in server response");
				}
			}
            function getLastActivity(ids){
				var fields = "expected_close_date,86c36896097d77ad77dbb52337a13f9799c72c16,1a0f93c059a93450fdb4b8d0bb26613fe0d6460,products_count,org_id,deal_title,last_activity,6b7027058f7b5ec5c9f6fd822a34a86adb8cc726";
				for(i = 1; i <= ids.length; i += 1){
					url = "https://api.pipedrive.com/v1/deals:(" + fields + ")/" + ids[i-1] + "?api_token=" + token;
					$.ajax({url: url,
							dataType: 'json',
							async: false,
							success: function(data){
								console.log(i + "/" + ids.length);
								i == ids.length ? addRow(data, true) : addRow(data, false);
							}
					});
				}
			}
			function addRow(data, now){
					var rec = data["data"];
					var row = [rec["expected_close_date"]];
					row.push(rec["86c36896097d77ad77dbb52337a13f9799c72c16"]);
					row.push(rec["1a0f93c059a93450fdb4b8d0bb26613fe0d6460f"]);
					row.push(rec["products_count"]);
					row.push(rec["org_id"]["name"]);
					row.push(rec["deal_title"]);
					row.push(rec["last_activity"]["type"]);
					row.push(rec["last_activity"]["add_time"]);
					row.push(rec["last_activity"]["done"]);
					row.push(rec["last_activity"]["marked_as_done_time"]);
					row.push(rec["6b7027058f7b5ec5c9f6fd822a34a86adb8cc726"]);
					row.push(rec["last_activity"]["note"]);
					console.log(row);
					for(var i = 1; i <= row.length; i += 1){
						csv += (i == row.length) ? row[i-1] + "\r\n" : row[i-1] + ",";
					}
					if(now){
						downNow = true;
					}
			}
			if(downNow){
				var encodedURI = encodeURI(csv);
				var link = document.createElement("a");
				link.setAttribute("href", encodedURI);
				link.setAttribute("download", new Date().toISOString() + ".csv");
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}
		});	
	</script>
</body>
</html>

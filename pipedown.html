<!DOCTYPE html>
<html lang="pt">
<head>
	<title>lnk2pipe - pipedown</title>
	<meta charset="utf-8">
	<meta name="description" content="Automating Pipedrive data download as CSV file">
	<meta name="keywords" content="pipedrive, automating, download, csv">
	<meta name="author" content="Artaxexes J. Ferreira">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="img/favicon.ico" type="image/x-icon">
	<!-- bootstrap -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
        div {
            text-align: center
        }
    </style>
</head>
<body>
	<div class="container">
		<div class="jumbotron">
			<a href="index.html"><h1>lnk2pipe</h1></a>
			<p>Interação (um pouco) automatizada com <a href="http://www.pipedrive.com" target="_blank">Pipedrive</a></p>
		</div>
		<div class="row">
			<div class="col-md-12">
				<p>Download de dados do <a href="http://www.pipedrive.com" target="_blank">Pipedrive</a> em formato de arquivo <a href="https://tools.ietf.org/html/rfc4180" target="_blank">CSV</a></p>
				<div class="form-group">
					<label for="token">Token:</label>
					<input type="text" class="form-control" id="token" size="40" value="0000000001000000000200000000030000000004" readonly>
					<span class="help-block">Seu token de API pessoal que pode ser encontrado em Ajustes > Pessoal > API no site do Pipedrive</span>
					<button type="submit" class="btn btn-default" id="token">Download</button>
				</div>
				<div class="panel-footer">
					<p>Problemas? <a href="mailto:anddrei.ferreira@biggdata.com.br?Subject=pipedown" target="_top">anddrei.ferreira@biggdata.com.br</a></p>
				</div>
			</div>
		</div>
	</div>
	<script>
        $("button").click(function(event){
            var token = document.getElementById("token").value;
            // URL requests: org name, title, expected close date, "competidor", "status", products count, next activity subject and note and "evento"
            var url = "https://api.pipedrive.com/v1/deals:(org_name,title,expected_close_date,86c36896097d77ad77dbb52337a13f9799c72c16,1a0f93c059a93450fdb4b8d0bb26613fe0d6460f,products_count,next_activity_subject,next_activity_note,6b7027058f7b5ec5c9f6fd822a34a86adb8cc726)?api_token=" + token;
            $.getJSON(url, function(res){
                if(res.data.length > 0){
                    var csv = "data:text/csv;charset=utf-8,";
                    csv += "Empresa,Oportunidade,Fechamento,Competidor,Status,Produtos,Nota,Evento\r\n";
                    for(var i = 0; i < res.data.length; i++){
                        var rec = res.data[i];
                        csv += "\"" + rec["org_name"] + "\",\"" + rec["title"] + "\"," + rec["expected_close_date"] + ",\"" + rec["86c36896097d77ad77dbb52337a13f9799c72c16"] + "\",\"" + rec["1a0f93c059a93450fdb4b8d0bb26613fe0d6460f"] + "\"," + rec["products_count"] + ",\"" + rec["next_activity_subject"] + ": " + rec["next_activity_note"] + "\",\"" + rec["6b7027058f7b5ec5c9f6fd822a34a86adb8cc726"] + "\"\r\n";
					}
				    var encodedURI = encodeURI(csv);
					var link = document.createElement('a');
					link.setAttribute('href', encodedURI);
					link.setAttribute('download', new Date().toISOString() + ".csv");
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
				} else {
					prompt("No deals!");
                }
			});
		});
	</script>
</body>
</html>
